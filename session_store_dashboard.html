<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Store ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
                 function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        async function showSessionDetail(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/api/session_store_info`);
                const info = await response.json();
                
                if (info.error) {
                    showMessage(info.error, 'error');
                    return;
                }
                
                const sessionData = info.sessions[sessionId];
                if (!sessionData) {
                    showMessage(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    return;
                }
                
                displaySessionDetailModal(sessionId, sessionData);
                
            } catch (error) {
                showMessage(`ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤º
        function displaySessionDetailModal(sessionId, data) {
            const modal = document.getElementById('sessionModal');
            const content = document.getElementById('sessionDetailContent');
            
            // ä¼šè©±ãƒ­ã‚°ã‚’æ•´å½¢
            let conversationHTML = '';
            if (data.conversation_logs && data.conversation_logs.length > 0) {
                conversationHTML = `
                    <h3>ä¼šè©±ãƒ­ã‚° (${data.conversation_logs.length}ä»¶)</h3>
                    <div class="conversation-log">
                `;
                
                data.conversation_logs.forEach((log, index) => {
                    const roleClass = log.role === 'user' ? 'conversation-user' : 'conversation-assistant';
                    const roleLabel = log.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';
                    conversationHTML += `
                        <div class="conversation-item ${roleClass}">
                            <div class="conversation-role">${roleLabel}:</div>
                            <div>${log.content || ''}</div>
                        </div>
                    `;
                });
                
                conversationHTML += '</div>';
            } else {
                conversationHTML = '<h3>ä¼šè©±ãƒ­ã‚°</h3><p>ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            // ãƒ¡ãƒ¢ãƒªæƒ…å ±ã‚’æ•´å½¢
            let memoryHTML = '';
            if (data.memory_store) {
                memoryHTML = `
                    <h3>ãƒ¡ãƒ¢ãƒªæƒ…å ±</h3>
                    <div class="memory-section">
                        <div class="memory-title">çŸ­æœŸè¨˜æ†¶:</div>
                        <div>${data.memory_store.shortMemories || '(ãªã—)'}</div>
                    </div>
                    <div class="memory-section">
                        <div class="memory-title">ä¸­æœŸè¨˜æ†¶:</div>
                        <div>${data.memory_store.midMemories || '(ãªã—)'}</div>
                    </div>
                    <div class="memory-section">
                        <div class="memory-title">é•·æœŸè¨˜æ†¶:</div>
                        <div>${data.memory_store.longMemories || '(ãªã—)'}</div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</div>
                    <div class="detail-value"><code>${sessionId}</code></div>
                    
                    <div class="detail-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</div>
                    <div class="detail-value">${data.userName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
                    
                    <div class="detail-label">ç§˜å¯†ã®ç´„æŸ:</div>
                    <div class="detail-value">${data.promise || '(æœªè¨­å®š)'}</div>
                    
                    <div class="detail-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID:</div>
                    <div class="detail-value">${data.character_id || '(æœªè¨­å®š)'}</div>
                    
                    <div class="detail-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å½¹å‰²:</div>
                    <div class="detail-value">${data.character_role || '(æœªè¨­å®š)'}</div>
                    
                    <div class="detail-label">TTSæœ‰åŠ¹:</div>
                    <div class="detail-value">${data.tts_enable ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</div>
                    
                    <div class="detail-label">ä¸­æ–­çŠ¶æ…‹:</div>
                    <div class="detail-value">${data.abort ? 'â¸ï¸ ä¸­æ–­ä¸­' : 'â–¶ï¸ æ­£å¸¸'}</div>
                    
                    <div class="detail-label">ä½œæˆæ™‚é–“:</div>
                    <div class="detail-value">${data.created_at || 'ä¸æ˜'}</div>
                    
                    <div class="detail-label">æœ€çµ‚æ´»å‹•:</div>
                    <div class="detail-value">${data.last_activity || 'ä¸æ˜'}</div>
                    
                    <div class="detail-label">ä¼šè©±æ•°:</div>
                    <div class="detail-value">${data.conversation_count || 0}ä»¶</div>
                </div>
                
                ${conversationHTML}
                ${memoryHTML}
            `;
            
            modal.style.display = 'block';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #bd2130;
        }
        .session-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .session-table th,
        .session-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .session-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .session-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .session-table tr:hover {
            background-color: #e9ecef;
        }
        .promise-list {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        .promise-item {
            background: white;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .session-detail {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.9em;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #bd2130;
        }
        .bulk-delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .bulk-delete-btn:hover {
            background-color: #bd2130;
        }
        .bulk-delete-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .select-all-container {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .session-checkbox {
            margin-right: 5px;
        }
        .session-id-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        .session-id-link:hover {
            color: #0056b3;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        .close:hover,
        .close:focus {
            color: #000;
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        .detail-value {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px;
            word-break: break-all;
        }
        .conversation-log {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .conversation-entry {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
        }
        .conversation-user {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .conversation-assistant {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .conversation-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        .conversation-role {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .conversation-content {
            white-space: pre-wrap;
            line-height: 1.4;
            padding: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .conversation-history {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
            border: none;
            border-radius: 0;
            background: transparent;
        }
        .accordion-panel .conversation-history {
            padding: 10px;
            background: #fff;
        }
        .memory-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .memory-log-section {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .memory-store-section {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .memory-log-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #17a2b8;
        }
        .memory-store-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        .memory-log-key, .memory-store-key {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .memory-log-value, .memory-store-value {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .memory-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #856404;
        }
        .accordion {
            background-color: #f8f9fa;
            color: #495057;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: 1px solid #dee2e6;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: bold;
            transition: 0.4s;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion:hover {
            background-color: #e9ecef;
        }
        .accordion.active {
            background-color: #007bff;
            color: white;
        }
        .accordion-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .accordion.active .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-panel {
            padding: 0;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .accordion-panel.show {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        .section-header h2 {
            margin: 0;
            color: #495057;
        }
        .last-update {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        .array-container {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background: #f8f9fa;
        }
        .array-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .array-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 8px;
            padding: 8px;
        }
        .array-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .item-number {
            font-weight: bold;
            color: #495057;
        }
        .item-timestamp {
            color: #6c757d;
            font-family: monospace;
        }
        .item-role {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .item-actions {
            display: flex;
            gap: 5px;
        }
        .btn-edit, .btn-delete, .btn-small, .btn-save, .btn-cancel {
            padding: 2px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .btn-edit {
            background: #007bff;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-small {
            background: #28a745;
            color: white;
        }
        .btn-save {
            background: #28a745;
            color: white;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        .btn-edit:hover { background: #0056b3; }
        .btn-delete:hover { background: #bd2130; }
        .btn-small:hover { background: #1e7e34; }
        .btn-save:hover { background: #1e7e34; }
        .btn-cancel:hover { background: #545b62; }
        .array-item-content {
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.85em;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .edit-form {
            background: #fff;
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 10px;
        }
        .edit-form input, .edit-form textarea, .edit-form select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
        }
        .edit-form textarea {
            height: 100px;
            resize: vertical;
        }
        .edit-form-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Session Store ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <div class="stats-grid" id="statsGrid">
            <!-- çµ±è¨ˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ æ›´æ–°</button>
            <button class="btn btn-success" onclick="saveSessionStore()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-primary" onclick="loadSessionStore()">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
            <button class="btn btn-warning" onclick="cleanupOldSessions()">ğŸ§¹ å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤</button>
            <button class="btn btn-danger" onclick="clearAllSessions()" 
                    onclick="return confirm('ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')">
                ğŸ—‘ï¸ å…¨å‰Šé™¤
            </button>
        </div>
        
        <div id="messageArea"></div>
        
        <div id="sessionDetails">
            <div class="section-header">
                <h2>ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°</h2>
                <div id="lastUpdateTime" class="last-update">
                    æœ€çµ‚æ›´æ–°: --
                </div>
            </div>
            <div class="select-all-container">
                <label>
                    <input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions()">
                    å…¨é¸æŠ
                </label>
                <button id="bulkDeleteBtn" class="bulk-delete-btn" onclick="bulkDeleteSessions()" disabled>
                    é¸æŠã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                </button>
                <span id="selectedCount" style="margin-left: 10px; color: #666;">
                    é¸æŠä¸­: 0ä»¶
                </span>
            </div>
            <div id="sessionTableContainer">
                <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
        
        <div id="promiseList">
            <!-- ç§˜å¯†ã®ç´„æŸãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°æƒ…å ±</h2>
            <div id="sessionModalContent">
                <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        async function refreshData() {
            try {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
                
                // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
                const statsResponse = await fetch(`${API_BASE}/api/session_store_stats`);
                const stats = await statsResponse.json();
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°æƒ…å ±ã‚’å–å¾—
                const infoResponse = await fetch(`${API_BASE}/api/session_store_info`);
                const info = await infoResponse.json();
                
                displayStats(stats);
                displaySessionDetails(info);
                displayPromiseList(stats.promise_list);
                
                // è‡ªå‹•å‰Šé™¤ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯é€šçŸ¥
                if (info.auto_deleted_sessions && info.auto_deleted_sessions.length > 0) {
                    showMessage(`è‡ªå‹•å‰Šé™¤: ${info.deleted_count}å€‹ã®å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'warning');
                }
                
                // æœ€çµ‚æ›´æ–°æ™‚é–“ã‚’è¡¨ç¤º
                updateLastUpdateTime();
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('messageArea').innerHTML = '';
                
            } catch (error) {
                showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_sessions || 0}</div>
                    <div class="stat-label">ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.sessions_with_promise || 0}</div>
                    <div class="stat-label">ç§˜å¯†ã®ç´„æŸã‚ã‚Š</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.sessions_with_username || 0}</div>
                    <div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®šæ¸ˆã¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_conversations || 0}</div>
                    <div class="stat-label">ç·ä¼šè©±æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.active_characters?.length || 0}</div>
                    <div class="stat-label">ãƒ¦ãƒ¼ã‚¶è¨­å®šæ¸ˆã¿ã‚­ãƒ£ãƒ©</div>
                </div>
            `;
        }
        
        function displaySessionDetails(info) {
            const sessionTableContainer = document.getElementById('sessionTableContainer');
            
            if (info.error) {
                sessionTableContainer.innerHTML = `<div class="error">${info.error}</div>`;
                return;
            }
            
            let tableHTML = `
                <table class="session-table">
                    <thead>
                        <tr>
                            <th>é¸æŠ</th>
                            <th>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th>ç§˜å¯†ã®ç´„æŸ</th>
                            <th>ä¼šè©±æ•°</th>
                            <th>TTS</th>
                            <th>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</th>
                            <th>ä½œæˆæ™‚é–“</th>
                            <th>æœ€çµ‚æ´»å‹•</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const [sessionId, data] of Object.entries(info.sessions || {})) {
                const hasPromise = data.promise ? 'âœ…' : 'âŒ';
                const ttsStatus = data.tts_enable ? 'ğŸ”Š' : 'ğŸ”‡';
                
                tableHTML += `
                    <tr>
                        <td><input type="checkbox" class="session-checkbox" value="${sessionId}" onchange="updateSelectedCount()"></td>
                        <td><code class="session-id-link" onclick="showSessionDetail('${sessionId}')">${sessionId}</code></td>
                        <td>${data.userName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</td>
                        <td>${hasPromise} ${data.promise ? '(è¨­å®šæ¸ˆã¿)' : '(æœªè¨­å®š)'}</td>
                        <td>${data.conversation_count || 0}</td>
                        <td>${ttsStatus}</td>
                        <td>${data.character_id || 'æœªè¨­å®š'}</td>
                        <td>${data.created_at || 'ä¸æ˜'}</td>
                        <td>${data.last_activity || 'ä¸æ˜'}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteSession('${sessionId}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            sessionTableContainer.innerHTML = tableHTML;
        }
        
        function displayPromiseList(promiseList) {
            const promiseListDiv = document.getElementById('promiseList');
            
            if (!promiseList || promiseList.length === 0) {
                promiseListDiv.innerHTML = '<h2>ğŸ” ç§˜å¯†ã®ç´„æŸ</h2><p>è¨­å®šã•ã‚ŒãŸç§˜å¯†ã®ç´„æŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            
            let html = '<h2>ğŸ” ç§˜å¯†ã®ç´„æŸä¸€è¦§</h2><div class="promise-list">';
            
            promiseList.forEach(item => {
                html += `
                    <div class="promise-item">
                        <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> <code>${item.session_id}</code><br>
                        <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${item.userName}<br>
                        <strong>ç´„æŸ:</strong> "${item.promise}"
                    </div>
                `;
            });
            
            html += '</div>';
            promiseListDiv.innerHTML = html;
        }
        
        async function saveSessionStore() {
            try {
                const response = await fetch(`${API_BASE}/api/save_session_store`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage(result.message, 'success');
                }
            } catch (error) {
                showMessage(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function loadSessionStore() {
            try {
                const response = await fetch(`${API_BASE}/api/load_session_store`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage(result.message, 'success');
                    refreshData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                showMessage(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function deleteSession(sessionId) {
            if (!confirm(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('sessionId', sessionId);
                
                const response = await fetch(`${API_BASE}/api/delete_session`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage(result.message, 'success');
                    refreshData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                showMessage(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function clearAllSessions() {
            if (!confirm('ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/clear_all_sessions`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    showMessage(result.message, 'success');
                    refreshData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                showMessage(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function cleanupOldSessions() {
            if (!confirm('æ¡ä»¶ã«åˆè‡´ã™ã‚‹å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆç§˜å¯†ã®ç´„æŸãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®šã€ä¼šè©±ãªã—ã€1æ—¥ä»¥ä¸Šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/cleanup_old_sessions`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.error) {
                    showMessage(result.error, 'error');
                } else {
                    if (result.deleted_count > 0) {
                        showMessage(`${result.deleted_count}å€‹ã®å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
                        console.log('å‰Šé™¤ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³:', result.deleted_sessions);
                    } else {
                        showMessage(result.message, 'info');
                    }
                    refreshData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                showMessage(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setupModalEvents();
        });
        
        // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
        setInterval(refreshData, 30000);
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½
        function showSessionDetail(sessionId) {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°æƒ…å ±ã‚’å–å¾—
            fetch(`${API_BASE}/api/session_store_info`)
                .then(response => response.json())
                .then(data => {
                    const session = data.sessions[sessionId];
                    if (session) {
                        displaySessionDetailModal(sessionId, session);
                    } else {
                        showMessage(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    }
                })
                .catch(error => {
                    showMessage(`ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                });
        }

        function displaySessionDetailModal(sessionId, sessionData) {
            const modalContent = document.getElementById('sessionModalContent');
            
            // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (!modalContent) {
                console.error('Modal content element not found');
                showMessage('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                return;
            }
            
            // åŸºæœ¬æƒ…å ±
            const createdAt = new Date(sessionData.created_at).toLocaleString('ja-JP');
            const lastActivity = sessionData.last_activity ? 
                new Date(sessionData.last_activity).toLocaleString('ja-JP') : 'ãªã—';
            
            // ä¼šè©±å±¥æ­´
            let conversationHtml = '';
            console.log('ä¼šè©±ãƒ‡ãƒ¼ã‚¿:', sessionData.conversation); // ãƒ‡ãƒãƒƒã‚°ç”¨
            if (sessionData.conversation && Array.isArray(sessionData.conversation) && sessionData.conversation.length > 0) {
                sessionData.conversation.forEach((entry, index) => {
                    const timestamp = entry.timestamp ? 
                        new Date(entry.timestamp).toLocaleString('ja-JP') : 
                        (entry.created_at ? new Date(entry.created_at).toLocaleString('ja-JP') : '');
                    const role = entry.role || 'unknown';
                    const content = entry.content || '';
                    
                    // å½¹å‰²ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
                    const roleClass = role === 'user' ? 'conversation-user' : 'conversation-assistant';
                    
                    conversationHtml += `
                        <div class="conversation-entry ${roleClass}">
                            <div class="conversation-meta">${index + 1}. ${timestamp}</div>
                            <div class="conversation-role"><strong>å½¹å‰²:</strong> ${role}</div>
                            <div class="conversation-content">${content}</div>
                        </div>
                    `;
                });
            } else {
                conversationHtml = '<p>ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                console.log('ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿:', sessionData);
            }
            
            // ãƒ¡ãƒ¢ãƒªæƒ…å ±
            let memoryHtml = '';
            if (sessionData.memory && Object.keys(sessionData.memory).length > 0) {
                for (const [key, value] of Object.entries(sessionData.memory)) {
                    memoryHtml += `
                        <div class="memory-item">
                            <div class="memory-key">${key}:</div>
                            <div class="memory-value">${JSON.stringify(value, null, 2)}</div>
                        </div>
                    `;
                }
            } else {
                memoryHtml = '<p>ãƒ¡ãƒ¢ãƒªæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            // long_conversation_logsæƒ…å ±
            let memoryLogHtml = '';
            if (sessionData.long_conversation_logs && Object.keys(sessionData.long_conversation_logs).length > 0) {
                for (const [key, value] of Object.entries(sessionData.long_conversation_logs)) {
                    let displayValue;
                    if (key === 'very_long_log' && Array.isArray(value)) {
                        // very_long_logãŒé…åˆ—ã®å ´åˆã®å‡¦ç†
                        if (value.length === 0) {
                            displayValue = '(ç©ºã®é…åˆ—)';
                        } else {
                            // é…åˆ—è¦ç´ ã‚’å€‹åˆ¥ã«ç·¨é›†å¯èƒ½ãªå½¢ã§è¡¨ç¤º
                            displayValue = `<div class="array-container">
                                <div class="array-header">é…åˆ— (${value.length}ä»¶)
                                    <button class="btn-small" onclick="addVeryLongLogItem('${sessionId}')">æ–°è¦è¿½åŠ </button>
                                </div>`;
                            value.forEach((item, index) => {
                                const timestamp = item.timestamp || 'æ™‚åˆ»ä¸æ˜';
                                const role = item.role || 'unknown';
                                const content = item.content || '';
                                const shortContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                                displayValue += `
                                    <div class="array-item" id="very-long-log-item-${index}">
                                        <div class="array-item-header">
                                            <span class="item-number">${index + 1}.</span>
                                            <span class="item-timestamp">[${timestamp}]</span>
                                            <span class="item-role">${role}</span>
                                            <div class="item-actions">
                                                <button class="btn-edit" onclick="editVeryLongLogItem('${sessionId}', ${index})">ç·¨é›†</button>
                                                <button class="btn-delete" onclick="deleteVeryLongLogItem('${sessionId}', ${index})">å‰Šé™¤</button>
                                            </div>
                                        </div>
                                        <div class="array-item-content" id="very-long-log-content-${index}">
                                            ${shortContent}
                                        </div>
                                    </div>
                                `;
                            });
                            displayValue += '</div>';
                        }
                    } else {
                        // å¾“æ¥ã®æ–‡å­—åˆ—å‡¦ç†
                        displayValue = value && value.trim() !== '' ? value : '(ç©º)';
                    }
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³ã¯é…åˆ—ã§ãªã„å ´åˆã®ã¿è¡¨ç¤ºï¼ˆvery_long_logã¯ç‹¬è‡ªã®ç·¨é›†æ©Ÿèƒ½ã‚’æŒã¤ï¼‰
                    const editButton = (key === 'very_long_log') ? 
                        '' : 
                        `<button class="edit-btn" onclick="editDeletedLog('${sessionId}','${key}')">ç·¨é›†</button>`;
                    
                    memoryLogHtml += `
                        <div class="memory-log-item" id="deleted-log-${key}">
                            <div class="memory-log-key">${key} ${editButton}</div>
                            <div class="memory-log-value" id="deleted-log-value-${key}">${displayValue}</div>
                        </div>
                    `;
                }
            } else {
                memoryLogHtml = '<p>é•·æœŸä¼šè©±ãƒ­ã‚°æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            // memory_storeæƒ…å ±
            let memoryStoreHtml = '';
            if (sessionData.memory_store && Object.keys(sessionData.memory_store).length > 0) {
                for (const [key, value] of Object.entries(sessionData.memory_store)) {
                    const displayValue = value && value.trim() !== '' ? value : '(ç©º)';
                    memoryStoreHtml += `
                        <div class="memory-store-item">
                            <div class="memory-store-key">${key}:</div>
                            <div class="memory-store-value">${displayValue}</div>
                        </div>
                    `;
                }
            } else {
                memoryStoreHtml = '<p>ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            modalContent.innerHTML = `
                <h3>ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°: ${sessionId}</h3>
                <div class="session-detail-section">
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${sessionData.userName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</p>
                    <p><strong>ä½œæˆæ—¥æ™‚:</strong> ${createdAt}</p>
                    <p><strong>æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£:</strong> ${lastActivity}</p>
                    <p><strong>ä¼šè©±æ•°:</strong> ${sessionData.conversation ? sessionData.conversation.length : 0}</p>
                </div>
                <div class="session-detail-section">
                    <button class="accordion" onclick="toggleAccordion('conversation-accordion')">
                        <span>ä¼šè©±å±¥æ­´ (${sessionData.conversation ? sessionData.conversation.length : 0}ä»¶)</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div id="conversation-accordion" class="accordion-panel">
                        <div class="conversation-history">
                            ${conversationHtml}
                        </div>
                    </div>
                </div>
                <div class="session-detail-section">
                    <button class="accordion" onclick="toggleAccordion('memory-accordion')">
                        <span>ãƒ¡ãƒ¢ãƒªæƒ…å ± (memory_store)</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div id="memory-accordion" class="accordion-panel">
                        <div class="memory-section">
                            ${memoryHtml}
                        </div>
                    </div>
                </div>
                <div class="session-detail-section">
                    <button class="accordion" onclick="toggleAccordion('memory-log-accordion')">
                        <span>é•·æœŸä¼šè©±ãƒ­ã‚° (long_conversation_logs)</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div id="memory-log-accordion" class="accordion-panel">
                        <div class="memory-log-section">
                            ${memoryLogHtml}
                        </div>
                    </div>
                </div>
                <div class="session-detail-section">
                    <button class="accordion" onclick="toggleAccordion('memory-store-accordion')">
                        <span>ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢ (memory_store)</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div id="memory-store-accordion" class="accordion-panel">
                        <div class="memory-store-section">
                            ${memoryStoreHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('sessionModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                console.error('Modal element not found');
                showMessage('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // é•·æœŸä¼šè©±ãƒ­ã‚°ã®ç·¨é›†æ©Ÿèƒ½
        function editDeletedLog(sessionId, key) {
            // very_long_logãŒé…åˆ—ã®å ´åˆã¯ç·¨é›†ä¸å¯
            if (key === 'very_long_log') {
                showMessage('very_long_logã¯é…åˆ—ã®ãŸã‚ã€ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            const itemDiv = document.getElementById(`deleted-log-${key}`);
            const valueDiv = document.getElementById(`deleted-log-value-${key}`);
            if (!itemDiv || !valueDiv) return;
            const oldValue = valueDiv.textContent;
            itemDiv.innerHTML = `
                <div class="memory-log-key">${key}:</div>
                <textarea id="edit-deleted-log-textarea-${key}" style="width:70%;height:12em;">${oldValue.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                <input type="hidden" id="edit-deleted-log-oldvalue-${key}" value="${oldValue.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
                <button onclick="saveDeletedLog('${sessionId}','${key}')">ä¿å­˜</button>
                <button onclick="cancelEditDeletedLog('${sessionId}','${key}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
        }

        function cancelEditDeletedLog(sessionId, key) {
            const itemDiv = document.getElementById(`deleted-log-${key}`);
            if (!itemDiv) return;
            // hidden inputã‹ã‚‰å…ƒã®å€¤ã‚’å–å¾—
            const oldValueInput = document.getElementById(`edit-deleted-log-oldvalue-${key}`);
            const oldValue = oldValueInput ? oldValueInput.value : '';
            itemDiv.innerHTML = `
                <div class="memory-log-key">${key}: <button class="edit-btn" onclick="editDeletedLog('${sessionId}','${key}')">ç·¨é›†</button></div>
                <div class="memory-log-value" id="deleted-log-value-${key}">${oldValue}</div>
            `;
        }

        async function saveDeletedLog(sessionId, key) {
            const textarea = document.getElementById(`edit-deleted-log-textarea-${key}`);
            if (!textarea) return;
            const newValue = textarea.value;
            try {
                const res = await fetch(`${API_BASE}/api/update_deleted_log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, key: key, value: newValue })
                });
                const result = await res.json();
                if (result.success) {
                    showMessage('é•·æœŸä¼šè©±ãƒ­ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    cancelEditDeletedLog(sessionId, key);
                } else {
                    showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''), 'error');
                }
            } catch (e) {
                showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç™»éŒ²
        window.editDeletedLog = editDeletedLog;
        window.cancelEditDeletedLog = cancelEditDeletedLog;
        window.saveDeletedLog = saveDeletedLog;
        window.editVeryLongLogItem = editVeryLongLogItem;
        window.deleteVeryLongLogItem = deleteVeryLongLogItem;
        window.addVeryLongLogItem = addVeryLongLogItem;
        window.saveVeryLongLogItem = saveVeryLongLogItem;
        window.cancelVeryLongLogEdit = cancelVeryLongLogEdit;
        
        // very_long_logé…åˆ—è¦ç´ ã®ç·¨é›†æ©Ÿèƒ½
        let currentSessionData = null; // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        
        async function editVeryLongLogItem(sessionId, index) {
            try {
                // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`${API_BASE}/api/session_store_info`);
                const info = await response.json();
                const sessionData = info.sessions[sessionId];
                
                if (!sessionData || !sessionData.long_conversation_logs || !sessionData.long_conversation_logs.very_long_log) {
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
                
                currentSessionData = sessionData;
                const item = sessionData.long_conversation_logs.very_long_log[index];
                const itemDiv = document.getElementById(`very-long-log-item-${index}`);
                
                if (!itemDiv || !item) return;
                
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                itemDiv.innerHTML = `
                    <div class="edit-form">
                        <label>å½¹å‰²:</label>
                        <select id="edit-role-${index}">
                            <option value="user" ${item.role === 'user' ? 'selected' : ''}>user</option>
                            <option value="assistant" ${item.role === 'assistant' ? 'selected' : ''}>assistant</option>
                        </select>
                        
                        <label>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:</label>
                        <input type="text" id="edit-timestamp-${index}" value="${item.timestamp || ''}" placeholder="YYYY-MM-DD HH:MM:SS">
                        
                        <label>å†…å®¹:</label>
                        <textarea id="edit-content-${index}" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹">${item.content || ''}</textarea>
                        
                        <div class="edit-form-actions">
                            <button class="btn-save" onclick="saveVeryLongLogItem('${sessionId}', ${index})">ä¿å­˜</button>
                            <button class="btn-cancel" onclick="cancelVeryLongLogEdit('${sessionId}', ${index})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                showMessage(`ç·¨é›†æº–å‚™ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function saveVeryLongLogItem(sessionId, index) {
            try {
                const role = document.getElementById(`edit-role-${index}`).value;
                const timestamp = document.getElementById(`edit-timestamp-${index}`).value;
                const content = document.getElementById(`edit-content-${index}`).value;
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!content.trim()) {
                    showMessage('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                // APIã«ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`${API_BASE}/api/update_very_long_log_item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        index: index,
                        item: {
                            role: role,
                            content: content,
                            timestamp: timestamp || new Date().toISOString().slice(0, 19).replace('T', ' ')
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('é…åˆ—è¦ç´ ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã—ã¦å¤‰æ›´ã‚’åæ˜ 
                    showSessionDetail(sessionId);
                } else {
                    showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''), 'error');
                }
                
            } catch (error) {
                showMessage(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function deleteVeryLongLogItem(sessionId, index) {
            if (!confirm('ã“ã®é…åˆ—è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/delete_very_long_log_item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        index: index
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('é…åˆ—è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã—ã¦å¤‰æ›´ã‚’åæ˜ 
                    showSessionDetail(sessionId);
                } else {
                    showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''), 'error');
                }
                
            } catch (error) {
                showMessage(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function addVeryLongLogItem(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/api/add_very_long_log_item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        item: {
                            role: 'user',
                            content: 'æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('æ–°ã—ã„è¦ç´ ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã—ã¦å¤‰æ›´ã‚’åæ˜ 
                    showSessionDetail(sessionId);
                } else {
                    showMessage('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''), 'error');
                }
                
            } catch (error) {
                showMessage(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function cancelVeryLongLogEdit(sessionId, index) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã—ã¦ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            showSessionDetail(sessionId);
        }
        
        // é¸æŠå‰Šé™¤æ©Ÿèƒ½
        function toggleAllSessions() {
            const selectAllCheckbox = document.getElementById('selectAllSessions');
            const sessionCheckboxes = document.querySelectorAll('.session-checkbox');
            
            sessionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.session-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            document.getElementById('selectedCount').textContent = `é¸æŠä¸­: ${count}ä»¶`;
            document.getElementById('bulkDeleteBtn').disabled = count === 0;
            
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const allCheckboxes = document.querySelectorAll('.session-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllSessions');
            
            if (count === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (count === allCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        async function bulkDeleteSessions() {
            const selectedCheckboxes = document.querySelectorAll('.session-checkbox:checked');
            const sessionIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (sessionIds.length === 0) {
                showMessage('å‰Šé™¤ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            if (!confirm(`é¸æŠã—ãŸ${sessionIds.length}å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const sessionId of sessionIds) {
                    try {
                        const formData = new FormData();
                        formData.append('sessionId', sessionId);
                        
                        const response = await fetch(`${API_BASE}/api/delete_session`, {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        
                        if (result.error) {
                            console.error(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionId} ã®å‰Šé™¤ã«å¤±æ•—:`, result.error);
                            errorCount++;
                        } else {
                            successCount++;
                        }
                    } catch (error) {
                        console.error(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionId} ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
                        errorCount++;
                    }
                }
                
                if (successCount > 0) {
                    showMessage(`${successCount}å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ${errorCount > 0 ? ` (${errorCount}å€‹ã®ã‚¨ãƒ©ãƒ¼)` : ''}`, 'success');
                    // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    resetSelectionState();
                    refreshData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    showMessage('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
                
            } catch (error) {
                showMessage(`ä¸€æ‹¬å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetSelectionState() {
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒªã‚»ãƒƒãƒˆ
            const selectAllCheckbox = document.getElementById('selectAllSessions');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒªã‚»ãƒƒãƒˆ
            const sessionCheckboxes = document.querySelectorAll('.session-checkbox');
            sessionCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // é¸æŠã‚«ã‚¦ãƒ³ãƒˆã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('selectedCount').textContent = 'é¸æŠä¸­: 0ä»¶';
            document.getElementById('bulkDeleteBtn').disabled = true;
        }
        
        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰åˆ¶å¾¡
        function toggleAccordion(accordionId) {
            const panel = document.getElementById(accordionId);
            const button = event.target.closest('.accordion');
            
            if (panel && button) {
                const isOpen = panel.classList.contains('show');
                
                if (isOpen) {
                    // é–‰ã˜ã‚‹
                    panel.classList.remove('show');
                    button.classList.remove('active');
                } else {
                    // é–‹ã
                    panel.classList.add('show');
                    button.classList.add('active');
                }
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ©Ÿèƒ½
        function setupModalEvents() {
            const modal = document.getElementById('sessionModal');
            const closeBtn = document.querySelector('.close');
            
            if (modal && closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
                
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            } else {
                console.warn('Modal elements not found during setup');
            }
        }
    </script>
</body>
</html>
